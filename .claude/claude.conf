# Claude Code Configuration for AquaSolv Watermark Removal Project

## Quick Start Guide

### Python Environment
- **Virtual environment location**: `./venv/`
- **Python interpreter**: `./venv/bin/python3`
- **Required packages**: numpy, pillow, scipy (already installed)
- **Usage**: Always use `./venv/bin/python3` instead of activating venv

Example commands:
```bash
./venv/bin/python3 remove_watermark.py "samples/example.png" -o "output/example.png"
./venv/bin/python3 analyze_difference.py
./venv/bin/python3 analyze_difference.py "image1.png" "image2.png"
```

### Testing & Accuracy

**IMPORTANT**: The desired/ directory contains the target output images. These files have an extra
alpha channel (RGBA) as an artifact of the editing program used to create them. Always convert to
RGB before comparison. The samples/ directory contains unprocessed input images, and output/
contains the current algorithm results.

#### ALWAYS use analyze_difference.py for accuracy testing
The analyze_difference.py script is the CORRECT way to measure accuracy. It:
- Converts images to RGB (handling RGBA in desired/)
- Focuses on bottom-right 100x100 corner (watermark region)
- Reports accuracy within 5 RGB units (target: ≥97%)
- Shows severity levels (diff >5, >10, >20, >50)
- Reports watermark center region [30:70, 30:70] accuracy separately
- Lists top 10 worst mismatched pixels with coordinates

```bash
# Analyze specific images (compares output/ vs desired/)
./venv/bin/python3 analyze_difference.py "the punchline.png" "apple ii.png"

# Or run test_all_samples.py to test all images at once
./venv/bin/python3 test_all_samples.py
```

### Accuracy Metrics
- **Target**: ≥97% overall accuracy (pixels within 5 RGB units) in 100x100 corner
- **Measurement area**: Bottom-right 100x100 corner where watermark appears
- **Watermark center**: Pixels [30:70, 30:70] within corner (where icon is most opaque)
- **Current status**: 16/49 images passing (33%), 33/49 failing (67%)
- Common failure mode: Residual brightening in watermark center (output ~150-170 vs desired ~50-90)

### Algorithm Overview

**Main script**: `remove_watermark.py`
- Detects Gemini sparkle watermarks in bottom-right corner [924:1024, 924:1024]
- Uses adaptive alpha blending reversal with Gaussian background estimation
- Handles multiple cases:
  - Standard bright watermarks on uniform backgrounds
  - Watermarks over L-pattern borders (template-based)
  - Watermarks over full-border frames (with correction)
  - Watermarks over multi-colored borders (with dark region detection)

**Key features**:
1. Auto-threshold detection (5-40 range, targets 500-4000 pixels)
2. Second-pass detection for watermarks over dark borders (mid-tone outliers)
3. Border correction for anti-aliased pixels (only when watermark brightness < 200)
4. Adaptive background estimation for high-variance cases

### Test Samples
Located in `samples/` with expected outputs in `desired/`:
- ch.png, 5u.png, w3.png, 0w.png, ca.png (standard cases)
- vintage shutters.png (watermark over black border)
- mormon lake.png (watermark over cream/dark-blue border)
- aurora borealis planet.png (bright watermark, skip border correction)

### Common Issues & Solutions

**Issue**: Border correction turning white pixels dark
**Solution**: Check if watermark brightness > 200, disable border correction

**Issue**: Watermark not fully detected on multi-colored backgrounds
**Solution**: Second-pass mid-tone detection (lines 243-265)

**Issue**: Gray artifacts where watermark crossed borders
**Solution**: Border correction post-processing (lines 978-1050)

### Development Notes
- Always test on all 8 samples before committing
- Read NOTES.md for algorithm evolution history
- Accuracy is measured on bottom-right 100x100 corner only
- Use analyze_difference.py to diagnose failures
