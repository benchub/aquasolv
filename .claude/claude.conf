# Claude Code Configuration for AquaSolv Watermark Removal Project

## Quick Start Guide

### Python Environment
- **Virtual environment location**: `./venv/`
- **Python interpreter**: `./venv/bin/python3`
- **Required packages**: numpy, pillow, scipy (already installed)
- **Usage**: Always use `./venv/bin/python3` instead of activating venv

Example commands:
```bash
./venv/bin/python3 remove_watermark.py "samples/example.png" -o "output/example.png"
./venv/bin/python3 analyze_difference.py
./venv/bin/python3 analyze_difference.py "image1.png" "image2.png"
```

### Testing & Accuracy

#### Quick accuracy check for all samples:
```python
./venv/bin/python3 << 'EOF'
import subprocess, numpy as np
from PIL import Image

samples = ["ch.png", "5u.png", "w3.png", "0w.png", "ca.png",
           "vintage shutters.png", "mormon lake.png", "aurora borealis planet.png"]

for name in samples:
    subprocess.run(['./venv/bin/python3', 'remove_watermark.py',
                   f'samples/{name}', '-o', f'output/{name}'],
                   capture_output=True, text=True)

    output = np.array(Image.open(f'output/{name}').convert('RGB'))
    desired = np.array(Image.open(f'desired/{name}').convert('RGB'))

    corner_out, corner_des = output[-100:, -100:], desired[-100:, -100:]
    diff = np.abs(corner_out.astype(float) - corner_des.astype(float))
    accuracy = (np.sum(diff <= 5) / corner_out.size) * 100

    status = "✓" if accuracy >= 96 else "⚠"
    print(f"{status} {name:30s} {accuracy:.2f}%")
EOF
```

#### Detailed analysis tool:
```bash
# All samples
./venv/bin/python3 analyze_difference.py

# Specific samples
./venv/bin/python3 analyze_difference.py "sample1.png" "sample2.png"
```

The analyze_difference.py script provides:
- Overall accuracy (within 5 RGB units)
- Severity levels (diff >5, >10, >20, >50)
- Watermark region [30:70, 30:70] accuracy
- Top 10 worst mismatched pixels with coordinates

### Accuracy Metrics
- **Target**: ≥96% overall accuracy (pixels within 5 RGB units)
- **Watermark region**: Focus on bottom-right 100x100 corner
- **Current performance**: All 8 test samples achieve 96-99.98%

### Algorithm Overview

**Main script**: `remove_watermark.py`
- Detects Gemini sparkle watermarks in bottom-right corner [924:1024, 924:1024]
- Uses adaptive alpha blending reversal with Gaussian background estimation
- Handles multiple cases:
  - Standard bright watermarks on uniform backgrounds
  - Watermarks over L-pattern borders (template-based)
  - Watermarks over full-border frames (with correction)
  - Watermarks over multi-colored borders (with dark region detection)

**Key features**:
1. Auto-threshold detection (5-40 range, targets 500-4000 pixels)
2. Second-pass detection for watermarks over dark borders (mid-tone outliers)
3. Border correction for anti-aliased pixels (only when watermark brightness < 200)
4. Adaptive background estimation for high-variance cases

### Test Samples
Located in `samples/` with expected outputs in `desired/`:
- ch.png, 5u.png, w3.png, 0w.png, ca.png (standard cases)
- vintage shutters.png (watermark over black border)
- mormon lake.png (watermark over cream/dark-blue border)
- aurora borealis planet.png (bright watermark, skip border correction)

### Common Issues & Solutions

**Issue**: Border correction turning white pixels dark
**Solution**: Check if watermark brightness > 200, disable border correction

**Issue**: Watermark not fully detected on multi-colored backgrounds
**Solution**: Second-pass mid-tone detection (lines 243-265)

**Issue**: Gray artifacts where watermark crossed borders
**Solution**: Border correction post-processing (lines 978-1050)

### Development Notes
- Always test on all 8 samples before committing
- Read NOTES.md for algorithm evolution history
- Accuracy is measured on bottom-right 100x100 corner only
- Use analyze_difference.py to diagnose failures
